@using static LowlandTech.Specs.UI.Components.ScenarioInfo

<div class="gherkin-block">
    <div class="bg-gray-900/50 px-4 py-2 flex items-center justify-between border-b border-gray-700">
        <span class="text-xs text-gray-400 font-semibold uppercase tracking-wider">Feature Specification</span>
        <span class="text-xs text-gray-500">@(Scenario.ClassName).feature</span>
    </div>

    
    <div class="py-3 text-gray-100">
        @* Tags *@
        @if (HasTags())
        {
            <div class="gherkin-line">
                @if (!string.IsNullOrWhiteSpace(Scenario.ScenarioAttribute.SpecId))
                {
                    <span class="gherkin-tag">@@@Scenario.ScenarioAttribute.SpecId</span><text> </text>
                }
                @if (!string.IsNullOrWhiteSpace(Scenario.ScenarioAttribute.UserStory))
                {
                    <span class="gherkin-tag">@@@Scenario.ScenarioAttribute.UserStory</span><text> </text>
                }
                @if (!string.IsNullOrWhiteSpace(Scenario.ScenarioAttribute.UseCase))
                {
                    <span class="gherkin-tag">@@@Scenario.ScenarioAttribute.UseCase</span><text> </text>
                }
                @if (!string.IsNullOrWhiteSpace(Scenario.ScenarioAttribute.ScenarioId))
                {
                    <span class="gherkin-tag">@@@Scenario.ScenarioAttribute.ScenarioId</span>
                }
            </div>
        }

        @* Scenario *@
        <div class="gherkin-line">
            <span class="gherkin-keyword">Scenario:</span>
            <span class="text-white ml-2">@(Scenario.ScenarioAttribute.Label ?? "Untitled")</span>
        </div>

        @* For comment *@
        @if (!string.IsNullOrWhiteSpace(Scenario.StateTypeName))
        {
            <div class="gherkin-line">
                <span class="gherkin-comment"># For: @Scenario.StateTypeName</span>
            </div>
        }

        @* Given steps *@
        @if (Scenario.GivenAttributes.Any())
        {
            @for (int i = 0; i < Scenario.GivenAttributes.Count; i++)
            {
                var given = Scenario.GivenAttributes[i];
                var keyword = i == 0 ? "Given" : "And";
                <div class="gherkin-line pl-8">
                    <span class="gherkin-keyword">@keyword</span>
                    <span class="gherkin-property ml-2">@given.Property</span>
                    <span class="gherkin-operator ml-1">@(given.Operator ?? "Equals")</span>
                    <span class="gherkin-number ml-1">@FormatValue(given.Value)</span>
                </div>
            }
        }

        @* When step *@
        @if (Scenario.WhenAttribute != null)
        {
            <div class="gherkin-line pl-8">
                <span class="gherkin-keyword">When</span>
                <span class="text-white ml-2">@Scenario.WhenAttribute.Action</span>
                @if (!string.IsNullOrWhiteSpace(Scenario.WhenAttribute.ActionType))
                {
                    <span class="gherkin-comment ml-1"># @Scenario.WhenAttribute.ActionType</span>
                }
            </div>
        }

        @* Then steps *@
        @foreach (var then in Scenario.ThenAttributes)
        {
            @if (!string.IsNullOrWhiteSpace(then.Attribute.Uat) || !string.IsNullOrWhiteSpace(then.Attribute.Comment))
            {
                <div class="gherkin-line pl-8">
                    <span class="gherkin-comment">#</span>
                    @if (!string.IsNullOrWhiteSpace(then.Attribute.Uat))
                    {
                        <span class="gherkin-tag ml-1">UAT-@then.Attribute.Uat</span>
                    }
                    @if (!string.IsNullOrWhiteSpace(then.Attribute.Comment))
                    {
                        <span class="gherkin-comment">: @then.Attribute.Comment</span>
                    }
                </div>
            }
            
            <div class="gherkin-line pl-8">
                <span class="gherkin-keyword">Then</span>
                @if (!string.IsNullOrWhiteSpace(then.Attribute.Property))
                {
                    <span class="gherkin-property ml-2">@then.Attribute.Property</span>
                    <span class="gherkin-operator ml-1">@(then.Attribute.Operator ?? "Equals")</span>
                    <span class="gherkin-number ml-1">@FormatValue(then.Attribute.Expected)</span>
                }
                else if (!string.IsNullOrWhiteSpace(then.Attribute.Assertion))
                {
                    <span class="text-white ml-2">@then.Attribute.Assertion</span>
                }
            </div>

            @if (!string.IsNullOrWhiteSpace(then.Attribute.PostconditionProperty))
            {
                <div class="gherkin-line pl-12">
                    <span class="gherkin-keyword">And</span>
                    <span class="gherkin-property ml-2">@then.Attribute.PostconditionProperty</span>
                    <span class="gherkin-operator ml-1">@(then.Attribute.PostconditionOperator ?? "Equals")</span>
                    <span class="gherkin-number ml-1">@FormatValue(then.Attribute.PostconditionExpected)</span>
                </div>
            }
        }
    </div>
</div>

@code {
    [Parameter, EditorRequired]
    public ScenarioInfo Scenario { get; set; } = null!;

    private bool HasTags()
    {
        return !string.IsNullOrWhiteSpace(Scenario.ScenarioAttribute.SpecId) ||
               !string.IsNullOrWhiteSpace(Scenario.ScenarioAttribute.UserStory) ||
               !string.IsNullOrWhiteSpace(Scenario.ScenarioAttribute.UseCase) ||
               !string.IsNullOrWhiteSpace(Scenario.ScenarioAttribute.ScenarioId);
    }

    private static string FormatValue(object? value)
    {
        if (value == null) return "null";
        if (value is string s) return $"\"{s}\"";
        return value.ToString() ?? "null";
    }
}
